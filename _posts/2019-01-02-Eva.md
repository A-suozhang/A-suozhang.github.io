---
layout:     post                    # ä½¿ç”¨çš„å¸ƒå±€ï¼ˆä¸éœ€è¦æ”¹ï¼‰
title:      Eva0å¼€å‘ç¬”è®°          # æ ‡é¢˜ 
subtitle:   ï¼ˆå¾…å¡«ä¸€ä¸ªevaæ¢—ï¼‰   #å‰¯æ ‡é¢˜
date:       2020-01-01        # æ—¶é—´
author:     tianchen                      # ä½œè€…
header-img:  img/10_1/bg-eva.jpg  #è¿™ç¯‡æ–‡ç« æ ‡é¢˜èƒŒæ™¯å›¾ç‰‡  
catalog: true                       # æ˜¯å¦å½’æ¡£
tags:                               #æ ‡ç­¾
     - ç¯å¢ƒé…ç½®
     - å¸¸ç”¨
---

# EVA å¼€å‘æ—¥è®°


> æœ¬postä¸­çš„å†…å®¹ç›¸å¯¹deprecatedï¼Œå…³äºevaé…ç½®çš„å†…å®¹å·²ç»æ›´æ–°åˆ°äº†[nicsefc-readme](https://github.com/thu-nics/nicsefc-readme)ä¸­ï¼Œå…¶ä»–å…³äºubuntué…ç½®çš„å†…å®¹ç›®å‰é¢„è®¡mergeåˆ°äº†[post-Ubuntué…ç½®](http://a-suozhang.xyz/2024/01/01/UbuntuSetup/)ä¸­

# å¸¸è§é—®é¢˜ Trouble Shooting

### A. è”ç½‘ç›¸å…³

1. pingçš„é€šåŸŸåï¼Œä½†æ˜¯ç™»å½•ä¸æ¯«æ²¡æœ‰ååº”ï¼Ÿ
- åŸºæœ¬æ˜¯åŸŸåæ²¡æœ‰å‡†å…¥ï¼Œä¸Šuseregç”¨è‡ªå·±çš„æ ¡å›­ç½‘è´¦å·è¿›è¡Œå‡†å…¥ã€‚æ³¨æ„å‡†å…¥æœ‰æ ¡å†…å’Œæ ¡å¤–ä¸¤ç§æƒ…å†µï¼Œæ ¡å†…ä¸è®¾ç½®ä¸Šé™ï¼Œæ ¡å¤–(å¯ä»¥è¿æ¥å¤–ç½‘)è®¾ç½®ä¸Šé™(å¦‚æœæœ‰æ–°çš„è®¾å¤‡ç™»å½•å¯èƒ½ä¼šè¢«æŒ¤æ‰)
- ä¸ªäººåœ¨è¿™é‡Œå»ºè®®æ˜¯ç”¨æ ¡å†…å‡†å…¥ï¼Œéœ€è¦è”å¤–ç½‘çš„æ—¶å€™ç™»é™†ä¸ŠæœåŠ¡å™¨å†ä½¿ç”¨è„šæœ¬è¿›è¡Œæ ¡å¤–å‡†å…¥ã€‚
- æœåŠ¡å™¨è„šæœ¬çš„è·å–æ–¹å¼ `scp -P 42222 zhaotianchen@101.6.64.67:/home/eva_share/auth-thu.linux.x86_64 ./` ç”¨ä½ è‡ªå·±å®éªŒå®¤è´¦æˆ·çš„å¯†ç è¿›è¡Œç™»å½•

2. å¯ä»¥æ­£å¸¸å‡†å…¥(æ˜¾ç¤º"ç™»å½•æˆåŠŸ")ï¼Œä½†æ˜¯pingä¸é€šcontainerçš„åŸŸå
- æ˜¯ip routeå‡ºé—®é¢˜äº†ï¼Œå¯ä»¥è”ç³»ç½‘ç®¡ç»™åˆ é™¤è·¯ç”±ï¼Œç›®å‰å»ºè®®å‚è€ƒä¸‹æ–¹```"å…·ä½“CaseæŒ‡å—: Crontabè‡ªåŠ¨åˆ é™¤è·¯ç”±ï¼Œæ¥è‡ªåŠ¨åŒ–è¯¥æµç¨‹"```

3. useregä¸­å‡†å…¥æŠ¥é”™ï¼Œâ€œä¸åœ¨ipè¡¨ä¸­â€æˆ–è€…è¿”å›ä¸€ä¸ªç©ºçš„å¯¹è¯æ¡†
- å¤§æ¦‚ç‡æ˜¯å­¦æ ¡é‚£è¾¹ipåˆ†é…å‡ºé—®é¢˜äº†ï¼Œç­‰ä¸€æ®µæ—¶é—´å†ç™»å½•
- å®åœ¨ç€æ€¥çš„è¯æ‰¾ç½‘ç®¡å»ç»™ä½ é‡æ–°æ‹¿ip(ä¸ä¸€å®šç®¡ç”¨ä¹Ÿï¼Œç½‘ç®¡èƒ½åšçš„ä¹Ÿåªæ˜¯attachè¿›ä¸»æœºdhcpä¸€ä¸‹ï¼Œå¯èƒ½IPå˜ä¸äº†)

### B. ç™»å½•ç›¸å…³

 1. èƒ½è¾“å…¥å¯†ç ï¼Œä¸€ç›´æŠ¥é”™Permission Denied
 - å†æ¬¡æ£€æŸ¥è‡ªå·±çš„å¤§å°å†™ç­‰ç­‰ï¼Œå¦‚æœä¸æ˜¯
 - å¤§æ¦‚ç‡æ˜¯è‡ªå·±ä¸åœ¨è¿™ä¸ªcontainerçš„login.user.allowé‡Œé¢ï¼Œè”ç³»Containerçš„ä¸»äººè¿›è¡Œæ·»åŠ 

#### C. CUDAç›¸å…³

> CUDAåœ¨æœåŠ¡å™¨é‡å¯ä¹‹åå¾ˆå®¹æ˜“å‡ºé—®é¢˜ï¼Œç¨å®‰å‹¿èº

0. å‘ç°nvdiia-smiæ²¡è¿™ä¸ªå‘½ä»¤
- æŠŠ`/usr/local/bin`åŠ åˆ°ç¯å¢ƒå˜é‡PATHä¸­ 

1. å‘ç°äº†Pytorchå•Šä»¥åŠå„ç§ç¨‹åº(nvidia-smi)æŠ¥é”™ 'cuda error'æˆ–è€…cudaä¸available
- é¦–å…ˆè¿›å…¥`/opt/cuda-x.x/samples/1_Utiliies/deviceQuery`(cudaç‰ˆæœ¬ä»¥ä½ å…·ä½“ç”¨åˆ°çš„cudaç‰ˆæœ¬ä¸€è‡´)**ä»¥sudoå½¢å¼**æ‰§è¡ŒdeviceQueryï¼Œè§‚å¯Ÿæ˜¯å¦PASSï¼Œå¦‚æœPASSäº†ï¼Œé‚£å¤§æ¦‚ç‡æ˜¯å¯ä»¥okäº†
- å¦‚æœæŠ¥é”™äº†`ERROR_CODE=100`çš„è¯ï¼Œå…ˆæ‰§è¡Œ`sudo ldconfig`ï¼Œå†æ‰§è¡Œä¸Šé¢çš„deviceQuery
- å¦‚æœå†å‡ºç°äº†åˆ«çš„é”™è¯¯ï¼Œå¯ä»¥å…ˆgoogleä¸€ä¸‹æŠ¥é”™æŒ‡ä»¤ï¼Œå¦‚æœæ²¡æœ‰è§£ç­”çš„è¯è”ç³»ç½‘ç®¡

3. deviceQueryèƒ½å¤ŸPASSï¼Œä½†æ˜¯ä¹‹ånvidia-smiå’Œå¯åŠ¨éƒ½å¾ˆæ…¢
- sudoè¿è¡Œ`/usr/local/nvidia/bin/nvidia-persistenced`

#### D. Containerç›¸å…³

0. To-fill

---

# å…·ä½“Case

## 1. Crontabè‡ªåŠ¨åˆ é™¤è·¯ç”±

**é—®é¢˜æè¿°**: æœåŠ¡å™¨æœ‰çš„æ—¶å€™ä¼šç™»å½•ä¸ä¸Šï¼Œuseregå¯ä»¥å…¥ç½‘ï¼Œä½†æ˜¯pingä¸é€šipï¼Œä¹Ÿæ— æ³•ç™»å½•
**åŸå› **: æ˜¯å› ä¸ºæœåŠ¡å™¨ç½‘ç»œå¯åŠ¨åï¼ŒLXC containerçš„è·¯ç”±ç¬¬ä¸€æ¡é»˜è®¤è·¯ç”±èµ°å‘äº†10.0.3.1ï¼Œéœ€è¦åˆ é™¤æ‰æ‰èƒ½æ­£å¸¸çš„ä»å¤–ç½‘ç™»å½•ï¼›æ‰§è¡Œ`ip route`å‘½ä»¤å¯ä»¥çœ‹åˆ°çº¢è‰²æ¡†é‡Œçš„æ¡ç›®åº”è¯¥è¢«åˆ é™¤(ç”¨æˆ·è§†è§’åº”è¯¥çœ‹ä¸åˆ°è¿™æ¡è·¯ç”±ï¼Œå› ä¸ºå¦‚æœæœ‰çš„è¯ä¼šæ— æ³•ç™»å½•ï¼Œä½†æ˜¯ä¹‹åå¯èƒ½åœ¨æŸæ¬¡é‡å¯ä¹‹åä¼šå‡ºç°)

![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210908190049.png)

**å…·ä½“è§£å†³æ–¹æ³•**: ä½¿ç”¨[crontab](https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/crontab.html)è„šæœ¬å®šæœŸåˆ é™¤è¯¥æ¡è·¯ç”±

å…·ä½“æ­¥éª¤:
0. è¿›å…¥root (`sudo su`)
1. é¦–å…ˆåœ¨è‡ªå·±çš„containerä¸­ä½¿ç”¨`service cron status`å‘½ä»¤æ£€æµ‹cronæœåŠ¡æ˜¯å¦å¼€å¯ï¼Œä¸‹å›¾ä¸ºæ­£ç¡®ç°è±¡

![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210908185524.png)

2. é˜…è¯»[crontabå‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•](https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/crontab.html)å¹¶è¿›è¡Œæ“ä½œ
æ‰§è¡Œ`crontab -e` ç¼–è¾‘æ–‡ä»¶

``` bash
* * * * * /sbin/route del default gw 10.0.3.1
```

è¡¨ç¤ºäº†æ¯1minæ‰§è¡Œä¸€æ¬¡åˆ é™¤é»˜è®¤èµ°å‘10.3.0.1çš„è·¯ç”±çš„æ“ä½œ(è°ƒè¯•ç”¨)
(æ³¨æ„ä¸€å®šè¦ç”¨`/sbin/route`å‘½ä»¤çš„ç»å¯¹è·¯å¾„ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨routeï¼Œè™½ç„¶åœ¨bashé‡Œå¯ä»¥ç›´æ¥ç”¨routeå‘½ä»¤ï¼Œä½†æ˜¯crontabä¸­ç¼ºå°‘ä¸€äº›ç¯å¢ƒå˜é‡ä¼šå¯¼è‡´routeå‘½ä»¤æ‰¾ä¸åˆ°)
3. ç­‰å¾…1minï¼Œå†æ¬¡æ‰§è¡Œ`service cron status`ï¼Œå¦‚æœçœ‹åˆ°è¿™ä¸ªå‘½ä»¤æ­£ç¡®æ‰§è¡Œäº†

![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210908190525.png)

ä¹‹åé‡æ–°ä¿®æ”¹ä¸º`* * * * * /sbin/route del default gw 10.0.3.1`æ¥æ¯åˆ†é’Ÿåˆ é™¤ä¸€æ¬¡
å¹¶ä¸”æ‰§è¡Œ`service cron restart`æ¥ä½¿å…¶ç”Ÿæ•ˆ

---

## 2. é€šè¿‡ä¿®æ”¹ifmetricä¿®æ”¹routeä¼˜å…ˆçº§

> eva7ä¸Šç”±äºubuntu18.04æ–‡ä»¶ç³»ç»Ÿæ›´æ–°äº†routeçš„è§„åˆ™ï¼Œå¯¼è‡´å¾€10.0.3.1çš„è·¯ç”±æˆä¸ºäº†ç¬¬ä¸€æ¡ï¼Œä¼šå¯¼è‡´pingä¸é€šcontainer1.

1. å®‰è£…ifmetricåŒ…  `sudo apt-get install ifmetric`
2. åˆ›å»º `/etc/networkd-dispatcher/routable.d/60-ifmetric` æ–‡ä»¶

```
#!/bin/sh
ifmetric eth1 200
```

- ~~ æœ‰äº›å°´å°¬çš„æ˜¯æš‚æ—¶çœ‹ä¸åˆ°ç»“æœï¼Œè¯¥æ“ä½œä»…ä¼šåœ¨containeré‡å¯ä¹‹åç”Ÿæ•ˆï¼Œç»è¿‡è¿™æ ·é…ç½®ä¹‹åå¼€æœºä¹‹årouteå°†ä¼šæ­£å¸¸ã€‚~~
- å¦‚æœæƒ³æ£€æŸ¥æ•ˆæœçš„è¯å¯ä»¥æ‰‹åŠ¨é‡å¯networkæœåŠ¡  `systemctl restart systemd-networkd.service`, å‘ç°å‡ºç°äº†metric=200å°±è¯´æ˜æˆåŠŸäº†

- ![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210918202607.png)




# ç½‘ç®¡ç›¸å…³

### LDAP related

æœ¬è´¨ä¸Šæ˜¯å¼€æœºä¹‹åæˆ‘ä»¬ä¼šä¸ä¸€ä¸ªè¿œç¨‹çš„æœåŠ¡å™¨è¿›è¡Œæ•°æ®å…±é€šï¼Œæ‹‰å–æˆ‘ä»¬å®éªŒå®¤è´¦æˆ·çš„ç”¨æˆ·åå¯†ç ï¼Œç„¶ååŒæ­¥åˆ°æœåŠ¡å™¨æœ¬åœ°ä¸»æœºã€‚(ç›¸å½“äºå…¨éƒ¨ç”¨æˆ·éƒ½ç»™useraddä¸Šå»äº†)
å¦å¤–containerå†…éƒ¨æœ¬è´¨ä¸Šä¹Ÿæ˜¯é€šè¿‡å’Œä¸»æœºå…±äº«LDAPæœåŠ¡ä»¥è¾¾æˆçš„è´¦æˆ·ã€‚

ä»¥åŠå…¶å®`/etc/login.user.allow`ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸LXCæˆ–è€…LDAP invariantçš„ä¸œè¥¿ï¼Œå°±æ˜¯å’Œsshç®¡ç†è¿™ä¸€å±‚çš„ï¼› ä¸è¿‡è¦æ³¨æ„è‡ªå·±useraddçš„ç”¨æˆ·ä¸è¦å’ŒLDAPçš„ç”¨æˆ·é‡å

1. ç™»å½•LDAPç³»ç»Ÿ
   * é€šè¿‡22222portç™»å½•ä¸Š205ï¼Œç„¶åå°†remoteçš„80ç«¯å£æ˜ å°„åˆ°æœ¬åœ°12888ç«¯å£
     * ï¼ˆç”±äºé»˜è®¤æ‰“å¼€æ–¹å¼ä¼šæ˜¾ç¤ºå®éªŒå®¤ç½‘é¡µï¼Œéœ€è¦ç”¨modeHelperæ’ä»¶è¾“å…¥ä¸€ä¸ªruleï¼›Hostï¼› ldap.nics.cc; å¼€å¯ä¹‹åå°±å¯ä»¥è¿›å…¥ï¼‰
     * ![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210404142533.png)
2. æ‰‹åŠ¨æ·»åŠ ç”¨æˆ·
   * åœ¨ç”¨æˆ·åˆ—è¡¨ä¸­ç”¨æœç´¢â€œSearchâ€
   * é…ç½®æ˜¾ç¤ºuidNumber
     * ![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210404142716.png)
   * æ‰¾åˆ°æœ€åä¸€ä¸ªç”¨æˆ·(uidæœ€å¤§çš„)ï¼Œæ³¨æ„ä¸ªæ•°è°ƒå¤§ä¸€ç‚¹
     * ç„¶åcopy from existing profile

![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210404143227.png)

3. æˆ–è€…æ˜¯è®©å®ƒä»¬è‡ªå·±æ³¨å†Œç”¨æˆ·
   * åœ¨å®éªŒå®¤å®˜ç½‘è¿›Internalè¿›è¡Œæ³¨å†Œï¼Œå®Œæˆä¹‹ååº”è¯¥å°±æœ‰å®éªŒå®¤è´¦å·äº†
   * éªŒè¯é—®é¢˜: ****

## æœåŠ¡å™¨è°ƒè¯•å¸¸ç”¨æ“ä½œ

1. æŸ¥çœ‹ç£ç›˜IO
   * ç°è±¡: vimä¿å­˜æ–‡ä»¶å¡é¡¿ï¼Œä½†æ˜¯tmuxåˆ‡æ¢çª—å£ä¸å¡é¡¿
   * ä½¿ç”¨`iotop`å‘½ä»¤ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å®‰è£…ä¸€ä¸‹ï¼Œåœ¨containerå†…éƒ¨æ˜¯ä¼šæŠ¥OSErrorï¼Œéœ€è¦ä¸»æœºä¸Šçš„sudoæƒé™

2. (å¾ˆå…³é”®) æŸ¥çœ‹æœåŠ¡å™¨å ç”¨å†…å­˜/CPUæœ€å¤šçš„ç¨‹åº
   * `ps auxw|head -1;ps auxw|sort -rn -k4|head -10 ` å†…å­˜ï¼ˆæ”¹æˆk3å°±æ˜¯CPUï¼Œk4æ˜¯å†…å­˜ï¼Œæ”¹æˆk5å°±æ˜¯è™šæ‹Ÿå†…å­˜ï¼‰
      * pså‘½ä»¤(process status):
        * ä¸€äº›args: ä¸€èˆ¬ç”¨çš„æ˜¯auxï¼Œå…¶ä¸­auè¡¨ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œxè¡¨ç¤ºä¹Ÿåˆ—å‡ºå…¶ä»–ç”¨æˆ·æ‰€ç”¨çš„ç¨‹åºï¼Œeåˆ™æ˜¯ç®€ç•¥çš„ï¼Œ-uæ˜¾ç¤ºæŸä¸ªuserçš„
        * è¾“å‡ºæ ¼å¼ `USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND`ï¼Œæ‰€ä»¥ä¸Šé¢çš„k3å°±æ˜¯CPU
      * sortå‘½ä»¤ï¼Œé€šè¿‡ç®¡é“å®ç°
        * -nè¡¨ç¤ºç”¨æ•°å­—æ¥è¿›è¡Œæ’åºï¼Œé»˜è®¤æ˜¯asciiå­—ç¬¦ç 
        * -r è¡¨ç¤ºå€’å™
        * -k 4 è¡¨ç¤ºç¬¬å››åˆ—   
   
3. æŸ¥çœ‹æŸä¸ªç”¨æˆ·çš„è¿›ç¨‹`top -u zhaotianchen`

4. å‘ç°è°åœ¨ç”¨å¡å»æŸ¥ä¸€ä¸‹ldapçœ‹ä¸€ä¸‹ä¸ªäººä¿¡æ¯
5. æŸ¥çœ‹æœåŠ¡:
  - `systemctl list-units --type=service`
  - `service --statua-all`

## æœåŠ¡å™¨é…ç½®ç›¸å…³

- [ä¿®æ”¹hostname](https://www.iplayio.cn/post/309740)


#### é…ç½®CUDA

> éœ€è¦çš„ç´ æ: NVIDIA_DRIVER.RUNï¼Œä¸¤ä¸ªé…ç½®ç›¸å…³çš„bashè„šæœ¬ï¼Œä»¥åŠä¸€ä¸ªCUDA_xx.RUN(optional), ç›®å‰è¿™äº›æ–‡ä»¶æ”¾åœ¨æ–°eva0çš„/home/zhaotianchen/setupé‡Œé¢

1. Nvidia-Driver:

éœ€è¦ä¸Šnvidiaå®˜ç½‘ä¸‹è½½ï¼Œæ ¹æ®ä½ å¡çš„ç‰ˆæœ¬æ¥å®š(æˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥ç›´æ¥refå…¶ä»–åŒç±»å¡çš„æœåŠ¡å™¨)
æ¯”å¦‚æˆ‘ä»¬ç›®å‰çš„`430.34.run / NVIDIA-Linux-x86_64-460.39-no-compat32.run`
è®°ä½ä¸è¦**ç›´æ¥runè¿™ä¸ªæ–‡ä»¶ï¼Œå…ˆé…ç½®ä»¥ä¸‹æ–‡ä»¶ï¼**

é¦–å…ˆæ˜¯`setup-nv-conf.sh`

``` bash
sudo touch /etc/ld.so.conf.d/nvidia.conf
# å°† nvidia è¿è¡Œæ—¶åº“ç›®å½•åŠ å…¥ ld æœç´¢ç›®å½•
echo "/usr/local/nvidia/lib" | sudo tee /etc/ld.so.conf.d/nvidia.conf
ldconfig
 
# å°† /usr/local/nvidia/bin åŠ å…¥ PATH
echo 'export PATH=$PATH:/usr/local/nvidia/bin' | sudo tee /etc/profile.d/nvidia.sh
sudo chmod +x /etc/profile.d/nvidia.sh
 
# å±è”½ nouveau æ¨¡å—
sudo tee /etc/modprobe.d/nvidia.conf < <(
cat << EOF
blacklist nouveau
options nouveau modeset=0
EOF
)
```

ç„¶åæ˜¯æ‰§è¡Œ`setup-nv-driver.sh`

``` bash
sudo apt-get install dkms

sudo ./NV-INSTALLER -a -s --dkms \
  --opengl-prefix="/usr/local/nvidia" \
  --installer-prefix="/usr/local/nvidia" \
  --utility-prefix="/usr/local/nvidia" \
  --no-install-compat32-libs
```

è·‘å®Œä¹‹ååº”è¯¥å°±æ­£å¸¸å®‰è£…åœ¨`/usr/local/nvidia`çš„ä½ç½®äº†
è¿™ä¸ªé‡Œé¢çš„binæ–‡ä»¶å¤¹ä¸­åº”è¯¥å°±å·²ç»æœ‰äº†nvidia-smiæ–‡ä»¶ï¼Œæ­£å¸¸æƒ…å†µå°±åº”è¯¥å‡ºä¸œè¥¿äº†ï¼Œå®‰è£…å®Œæˆ

è¿™ä¹‹ååº”è¯¥å®‰è£…CUDAï¼Œè²Œä¼¼å¯ä»¥ç›´æ¥ä»å…¶ä»–æœåŠ¡å™¨çš„/opt/cuda-xx.ï¼› æˆ–è€…ä½¿ç”¨CUDA_11.runçš„æ–¹å¼æ¥å®‰è£…

- **æˆ‘ä»¬CUDAçš„ä½ç½®å’Œé»˜è®¤ä½ç½®æœ‰åŒºåˆ«ï¼Œéœ€è¦åšä»¥ä¸‹è°ƒæ•´ï¼Œå®ç°cudaæ ‡å‡†åŒ–  **

ç”±äºæˆ‘ä»¬çš„cudaä»¥åŠnvidia-driverçš„ä½ç½®ä¸æ ‡å‡†çš„ä¸ä¸€æ ·ï¼Œæ­£å¸¸éƒ½æ˜¯åœ¨`/usr/local/lib`æˆ–è€…æ˜¯`/usr/lib`å½“ä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬çš„cudaåœ¨`/opt/cuda`ä¸­ï¼Œè€Œnvidia-driveråœ¨`/usr/local/nvidai/lib`è¿™æ ·çš„ä½ç½®ï¼Œæ‰€ä»¥æœ‰ä¸€äº›ä¾‹ç¨‹ä¼šå¾ˆå®¹æ˜“æŠ¥é”™åœ¨`/usr/lib`çš„ä½ç½®æ‰¾ä¸åˆ°æŸäº›`cuda.h`æˆ–è€…æ˜¯`libcuda.so`æ–‡ä»¶è¿™æ ·çš„é—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆæ˜¯æ‰‹åŠ¨æ·»åŠ è½¯è¿æ¥ã€‚

`ln -s /usr/local/nvidia/lib/* /usr/local/lib/`
`ln -s /opt/cuda-11.1/ /usr/local/cuda`


## LXCçŸ¥è¯†ç›¸å…³

* LXCèƒ½é€šè¿‡æ”¹å˜/var/lib/ä¸­çš„cfgä»¥åŠå…¶ä»–å†…å®¹åŠ¨æ€ç®¡ç†å„ä¸ªcontainer
* å¸¸ç”¨å‘½ä»¤
  * `lxc-ls -f` æŸ¥çœ‹å„ä¸ªcontainerçš„ä¿¡æ¯
  * `lxc-start -n XXX` å¯åŠ¨container
  * `lxc-attach -n xxx` ä»ä¸»æœºè¿›å…¥æŸä¸ªcontainer
  * `lxc-top`
  * `lxc-monitor`

### Containerç»´æŠ¤ç›¸å…³

[ LXC Linuxç³»ç»Ÿå®¹å™¨ - æŸç§‘å­¦çš„æœ€åä¹‹ä½œ (yunfwe.cn)](https://yunfwe.cn/2019/09/23/2019/LXC Linuxç³»ç»Ÿå®¹å™¨/)

##### 1. å¦‚ä½•å¼€ä¸€ä¸ªæ–°çš„Container

   * ç™»å½•ä¸»æœºï¼Œè¿›å…¥root
   * /home/work/lxc ä¸­æœ‰ä¸€ä¸ªfork_lxc_new.pyæ–‡ä»¶ï¼Œæœ‰ä»¥ä¸‹çš„è¾“å…¥argséœ€è¦å¡«å†™
     * -nï¼š containerçš„åå­—
     * -uï¼š userï¼Œéœ€è¦å’Œ/etc/login.user.allowå¯¹åº”ï¼Œå¯ä»¥ç”¨é€—å·éš”å¼€
     * --rootfs-size: ä¸€ä¸ªintè¡¨ç¤ºGB
     * --rootfs-prefix: è¡¨ç¤ºæŒ‚è½½åœ¨å“ªå—ç¡¬ç›˜ä¸Šï¼Œè¾“å…¥æ¯”å¦‚`/mnt/sdd` (äº‹å…ˆdf -khæŸ¥ä¸‹å“ªä¸ªç›˜æœ‰ç©ºé—´)
     * --bionicï¼š è¡¨ç¤ºæ˜¯å¦æ˜¯18.04
   * å‘ä¸ªé‚®ä»¶å‘Šè¯‰åˆ«äºº
   * æŒ‰ç…§å½“å‰å‘½ä»¤æ‰§è¡Œå°±å¯ä»¥ä»ä¸€äº›å¯¹åº”ä½ç½®è¯»å–ä¸€äº›é»˜è®¤cfgå¹¶ä¸”æ‰§è¡Œå°†ç©ºç™½æ–‡ä»¶ç³»ç»Ÿå¤åˆ¶åˆ°å¯¹åº”çš„ä½ç½®
     * /home/work/lxc/templates_lxc
       * config: lxcçš„cfg
       * login.user.allowï¼ˆé»˜è®¤æœ‰ç½‘ç®¡çš„ï¼‰
     * /var/lib/lxc/ubuntu-cuda-base/rootfs.new(é»˜è®¤çš„ç©ºç™½æ–‡ä»¶ç³»ç»Ÿ)

* ç›®å‰å·²ç»èƒ½å¤Ÿç™»å½•å„ä¸ªä¸»æœº eva*.nics.cc
  * åœ¨æœ¬åœ°configé‡Œæ˜¯ç”¨ssh eva8 è¿™ç§å‘½ä»¤æ¥ç›´æ¥ç™»å½•
* srvAdminç»„:
  * ä»£è¡¨äº†å¯¹ä¸»æœºå’Œcontainerçš„sudoæƒé™
  * è™½ç„¶æœ‰containerçš„sudoæƒé™ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦containerçš„è¿›å…¥æƒé™ï¼›å¯ä»¥ç›´æ¥è¿›å…¥ä¸»æœºattachè¿›å»ç„¶åç»™`/etc/login.user.allow`
* [å‡¯å“¥çš„ç½‘ç®¡éƒ¨æŠ€æœ¯æ•´ç†](https://www.yuque.com/doctor-kaizhong/lab-network)

#### 2. æ”¹Rootfsçš„å¤§å°

* å…ˆstopåˆ°å½“å‰çš„container
* å‚è€ƒfork_lxc_newä¸­è„šæœ¬ä¸­çš„å‡ è¡Œä»£ç 
  * ![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210730103216.png)
* å…¶ä¸­çš„rootfs pathä»`/var/lib/lxc/$NAME`ä¸­æ‰¾rootfsæ‰€linkåˆ°çš„ä½ç½®ï¼Œæ˜¯`/data2/lxc/ztc`å¯¹åº”ä½ç½®çš„ç¡®å®æ˜¯å¤§æ–‡ä»¶
  * ![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210730103356.png)
* æ”¾äº†ä¸€ä¸ªè„šæœ¬åœ¨`/home/woirk/lxc/resizefs.sh`

#### 3. æœåŠ¡å™¨è‡ªåŠ¨å…¥ç½‘:

* å…¥ç½‘çš„è„šæœ¬auth-linuxæˆ‘æ”¾åœ¨205çš„`/home/eva_share`ä¸‹äº†ï¼Œä¹‹åå¯ä»¥ä»è¿™é‡Œscpï¼Œä»¥åŠè·³æ¿æœºä¸Š`scp -P 42222 zhaotianchen@101.6.64.67:/home/eva_share/auth-thu.linux.x86_64 ./`

* åœ¨æˆ‘çš„æœåŠ¡å™¨çš„homeç›®å½•ä¸‹å†™äº†ä¸€ä¸ªconfigï¼Œç„¶ååªè¦ç›´æ¥æ‰§è¡Œ./authå°±å¯ä»¥äº†ï¼Œéœ€è¦å†™ä¸€ä¸ªcrontab
  * [19. crontab å®šæ—¶ä»»åŠ¡ â€” Linux Tools Quick Tutorial (linuxtools-rst.readthedocs.io)](https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/crontab.html)
  * still not safe enough, since should save passwd

* å†™ä¸€ä¸ªcrontabè„šæœ¬ `ping info.tsinghua.edu.cn` è®©å®ƒä¸€ç›´åœ¨å†…ç½‘ä¸­, and use the ztc.eva7.nics.cc to login

* åˆ›å»ºä¸€ä¸ªè„šæœ¬ä¹‹åï¼Œ`crontab $FILENAME`,ä¹‹å`contab -l`æŸ¥çœ‹ä»€ä¹ˆæ­£åœ¨æ‰§è¡Œ
  * `crontab -e `ç›´æ¥ç¼–è¾‘
  * `crontab -r` åˆ é™¤

4. eva7ä¸Šçš„ç‰¹æ®Šè·¯ç”±æ–¹å¼ï¼Œä»æŸä¸ªç«¯å£ç™»å½•æœåŠ¡å™¨

* åœ¨ä¸»æœºä¸Šç”¨`iptables -t nat -L` çœ‹äº†è¿™ä¸¤æ¡ruleï¼Œå…¶ä¸­å°†32223ç«¯å£ç»‘å®š(ç›®å‰è¿˜æ˜¯æŠŠè¿™ç§æ–¹å¼æ”¹æ‰äº†â€¦é‡å¯ä¹‹åå°±æ²¡äº†ï¼Œç•™æ¡£)
* ![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210911200948.png)

#### 4. ä¿®æ”¹rootfs-template

* ç”±äºlxcå¯ä»¥åœ¨`/var/lib/lxc`ä¸­ç›´æ¥ä¿®æ”¹é…ç½®ä»¥åŠrootfs
* æ‰€ä»¥ç›´æ¥åœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªsandboxæ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”æ‹·è´ä¸€ä»½å…¶ä»–containerçš„configæ–‡ä»¶è¿‡æ¥(éœ€è¦ä¿®æ”¹nameï¼Œrootfsçš„ä½ç½®ï¼Œä»¥åŠç½‘å¡çš„hwaddrï¼Œå¦åˆ™ä¼šæŠ¥é”™address already in use)ï¼Œå¹¶ä¸”å°†éœ€è¦ä¿®æ”¹çš„rootfsè½¯è¿æ¥åˆ°è¿™é‡Œæ¥

![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210909125956.png)

* lxc-lsæŸ¥çœ‹åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æ–°çš„sandbox containeräº†ï¼Œå°è¯•startå®ƒï¼Œ(å¯èƒ½ä¼šæŠ¥é”™æ‰€ä»¥å¯ä»¥ç”¨ `lxc-start sandbox --logfile ./logs` å°†æŠ¥é”™ä¿¡æ¯æ‰“å°åˆ°logæ–‡ä»¶ä¸­)
  * å¦‚æœå¯åŠ¨é‡åˆ°äº†ä¸€äº›é—®é¢˜éœ€è¦æ”¹åŠ¨è¿™ä¸ªrootfsï¼Œé‚£ä¹ˆå°±å°†è¿™ä¸ªæ–‡ä»¶ç»™æŒ‚è½½åˆ°æŸä¸ªç›®å½•ä¸‹`mount rootfs /media/rootfs`,ç„¶åchrootåˆ°`chroot /media/rootfs`,è¿›è¡Œä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿ
* lxc-attachè¿›å»ï¼Œåšæ”¹åŠ¨ï¼Œç„¶åä¹Ÿä¸ç”¨ä¿å­˜ï¼Œè‡ªåŠ¨å°±æ”¹äº†

#### 5. è®¾ç½®Routeçš„Metricä»¥Fix routeé—®é¢˜

* åœ¨ubuntu18.04ä¹‹åç”±äºrouteè§„åˆ™çš„æ”¹å˜ï¼Œrouteè§„åˆ™ä¼šå°†`10.0.3.1`çš„ä¸€æ¡æ”¾åœ¨é¦–æ¡ï¼Œå¯¼è‡´åœ¨å¤–é¢æ— æ³•ç™»å½•
* é€šè¿‡ä¿®æ”¹ä¸åŒip routeè§„åˆ™çš„metricå¯ä»¥è§£å†³:
* å®ç°æ–¹å¼(ç›®å‰å·²ç»åœ¨æˆ‘ä»¬eva7ä¸Šçš„base-rootfsä¸­ä¿®æ”¹å®Œæˆäº†)
  * åœ¨`/etc/networkd-dispatcher/routable.d`ä¸­æ·»åŠ äº†ä¸€ä¸ªè„šæœ¬ï¼Œå†…å®¹ä¸º`ifmetric eth1 200` (é€šè¿‡ifmetricåº“å®ç°ï¼Œéœ€è¦åŠ åˆ°æˆ‘ä»¬çš„é»˜è®¤rootfsé‡Œ)
  * è¿™ä¸ªè„šæœ¬å°†eth1(ä¸»æœºä¸Šç”±lxc-bridgeæ‰€äº§ç”Ÿçš„è™šæ‹Ÿç½‘å¡çš„route)ä¼˜å…ˆçº§å˜ä½ï¼Œmetricçš„å€¼è¶Šé«˜å°±è¶Šä¸ä¼˜å…ˆ
  * å¦å¤–è¿˜éœ€è¦å®‰è£…`ifmetricè¿™ä¸ªpackage`
* **æ³¨æ„å…¶ä»–æœåŠ¡å™¨ä¸Šçš„base-rootfsè¿˜æ˜¯æ²¡æœ‰æ”¹è¿‡çš„ï¼**

#### 6. è€æœåŠ¡å™¨è¿ç§»è®¡åˆ’

> reviveçš„è€æœåŠ¡å™¨å°†ä»¥EOEå‘½åï¼Œå‚è€ƒé‡äº§æœºï¼ŒåˆåEnd Of Evagelionï¼Œè¡¨ç¤ºé€€å½¹ä¹‹åé‡æ–°åŠ å…¥ä½¿ç”¨çš„Eva
> EOEç³»åˆ—çš„containerçš„Macåœ°å€ä¸­çš„å€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚(2ä¸ª16è¿›åˆ¶æ•°)ï¼Œä¸º`dN`çš„å½¢å¼ï¼Œä¸ºäº†ä¸evaçš„`eN`åŒºåˆ†å¼€ï¼Œå¦åˆ™ä¼šé€ æˆdhcpé”™è¯¯
> EOEç³»åˆ—çš„tincåœ°å€ï¼Œå°†ä»`10. 4.205.50`å¼€å§‹è¿›è¡Œæ’åˆ—(tinc-upä¸tinc-downä¸­)

* [2021-09-11] å°è¯•å°†è€eva7(ç°EOE-0)è¿›è¡Œå¤æ´»çš„æ—¶å€™ï¼Œç”±äºæ²¡æœ‰ä¿®æ”¹lxc configï¼Œå¯¼è‡´containerä¸æ–°eva7çš„containerä¸­shareäº†ç¡¬ä»¶hwaddrï¼Œä»è€Œå¯¼è‡´DHCPæ­¥éª¤å‡ºé”™ï¼Œè®©åŒä¸€ä¸ªipåœ°å€è¢«ä¸¤ä¸ªè™šæ‹Ÿlxcç¯å¢ƒï¼Œç™»å½•æ—¶å‡ºé”™ï¼š 
  * ![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210911195914.png)
* éœ€è¦ä¿®æ”¹lxc-configä¸­çš„ä¸¤ä¸ªä½ç½®çš„hw-addr:
  * ![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210911202514.png)
  * æˆ‘ä»¬ä¸€èˆ¬çš„ruleæ˜¯e7è¡¨ç¤ºeva7ï¼› f0è¡¨ç¤ºeva0ï¼› å¯¹eoe0ï¼Œæˆ‘æš‚æ—¶æ”¹æˆäº†d0ã€‚
  * `for name in `lxc-ls`; do sed -i "s/e5/d1/g" ./$name/config; done`
  * å®Œæˆäº†è¿™ä¸€æ­¥ç†è®ºä¸Šå°±å¯ä»¥æ­£å¸¸ç™»å½•äº†(ç”¨ç»å¯¹IP)
* **ç›®å‰å¯¹äºeoe0åªå¯¹äº†æœ€æ–°çš„wcy containerè¿›è¡Œäº†ä¿®æ”¹ï¼Œå¦‚æœè€containeréœ€è¦èµ·æ¥çš„è¯ï¼Œä¹Ÿéœ€è¦åšç±»ä¼¼çš„æ“ä½œï¼Œä½†æ˜¯ç›®å‰è¿˜æ²¡åš**
* ä¸ºäº†è®©åŸŸåç­‰ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦é…ç½®å¥½tincä»¥åŠdnsï¼Œå‚è€ƒ[å‡¯å“¥çš„ç½‘ç®¡æ€»ç»“ - ç½‘ç»œé…ç½®](https://www.yuque.com/doctor-kaizhong/lab-network/lo5q51)ä¸­çš„æ•´ä¸ªæµç¨‹
  * ä¿®æ”¹hostname: éœ€è¦ä¿®æ”¹ `/etc/hostname` ä»¥åŠ `/etc/hosts` ï¼Œä½¿ç”¨hostnameå‘½ä»¤å°±å¯ä»¥çœ‹åˆ°hostnameï¼Œç”±äºå®éªŒå®¤ç”¨åˆ°äº†tincæœåŠ¡ï¼Œåœ¨`/etc/tinc/tinc.conf`ä¸­ä¹Ÿåšä¿®æ”¹ï¼Œé€šè¿‡tincå°†æ–°çš„åŸŸåç»„æ¨åˆ°205ä¸­ï¼Œä¾¿äº205ä¸Šçš„DNSæœåŠ¡å™¨æ›´æ–°åŸŸåè§£æã€‚
* å³ä¾¿æœ€å`service tinc status`æ˜¾ç¤ºtinc-upæœ‰`exit with error code2`ï¼Œä½†æ˜¯èƒ½å¤Ÿæ­£å¸¸çš„pingé€š`10.4.205.1`(205ä¸»æœºçš„ip)ï¼Œæš‚æ—¶æ²¡æœ‰é—®é¢˜äº†ï¼›ä»¥åŠæ‰§è¡Œè¿‡äº†crontabè„šæœ¬ä¸­å°†ä¿¡æ¯ä»tincæ¨é€åˆ°205éƒ¨åˆ†é€»è¾‘ï¼Œä¹Ÿæ˜¯okçš„ã€‚
* å·²ç»å»ºç«‹å¥½çš„containerçš„hostnameï¼Œè¿›å…¥æ–‡ä»¶ç³»ç»Ÿç›´æ¥ä¿®æ”¹`/etc/hostname`è¿™ä¸ªæ˜¯å»ºç«‹containerçš„æ—¶å€™å°±ç¡®å®šçš„ï¼Œåœ¨`fork_lxc_new.py`æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨äº†`socket.gethostname()æ¥è·å–æœ¬æœºçš„hostname`ï¼Œä¸‹é¢ä¸€æ®µé€»è¾‘æ˜¯åˆ›å»ºcontainerçš„æ—¶å€™ï¼Œå°†è¿™äº›ä¿¡æ¯å†™å…¥åˆ°äº†template_rootfsçš„`/etc`æ‰€å¯¹åº”çš„æ–‡ä»¶ä¸­
  * ![](https://github.com/A-suozhang/MyPicBed/raw/master//img/20210911203937.png)


---

# SSHé…ç½®

* ç°åœ¨çš„æ–°çš„Configæ–‡ä»¶çš„å†…å®¹

```
Host eva
	HostName 101.6.64.169
	Port 22
	User zhaotianchen
	ProxyCommand ssh zhaotianchen@101.6.64.67 -p 42222 -W %h:%p
Host fpga
	HostName 101.6.68.236
	Port 22
	User ztc
	ProxyCommand ssh zhaotianchen@101.6.64.67 -p 42222 -W %h:%p

Host 205
  ForwardAgent yes
  HostName 101.6.64.67
  User zhaotianchen
  Port 42222

Host eva*
  HostName %h.nics.cc
  User zhaotianchen
  ProxyCommand ssh zhaotianchen@205 nc %h %p

Host proxy-eva10
  HostName eva10.nics.cc
  Port 32222
  User zhaotianchen
  ProxyCommand ssh zhaotianchen@205 nc %h %p

Host ztc.eva10
  HostName foxfi-eva10
  User zhaotianchen
  ProxyCommand ssh -p 32222 zhaotianchen@eva10 nc %h %p

Host *.eva*
  HostName %h.nics.cc
  User zhaotianchen
  ForwardAgent yes
  ProxyCommand ssh zhaotianchen@205 nc %h %p

```

* ä¸€äº›è§£é‡Šæ€§çš„æ–‡å­—
  * ncè¡¨ç¤ºä¸è¦å†Proxyåœä¸‹æ¥
  * %h è¡¨ç¤ºäº†HostName
  * %p è¡¨ç¤ºäº†Port
* ç»è¿‡è¿™æ ·çš„ä¸€å¥—é…ç½®åº”è¯¥æ˜¯å¯ä»¥ç”¨```ssh ztc.eva10```è¿™æ ·çš„å‘½ä»¤ç›´æ¥è·³è¿‡ä¸¤æ¬¡è·³æ¿æœºè·³ä¸Šå»äº†
  * å¯¹äºä¸€äº›é¢å¤–çš„é…ç½®æ¯”å¦‚è¯´ç«¯å£æ˜ å°„ï¼Œå¯ä»¥ç›´æ¥åŠ è½½æœ€åçš„è¿™ä¸ªæŒ‡ä»¤ä¸­æ¯”å¦‚ ```ssh -L 10808:localhost:127.0.0.1 ztc.eva10``` 
* å…³äºä¸Šä¼ ç§é’¥ä»¥å…å¯†ç ç™»å½•
  * é¦–å…ˆå†æœ¬åœ°è¿›è¡Œssh-keygenï¼Œä¼šæœ‰ä¸€ä¸ªid_rsaï¼ˆç§é’¥ï¼‰ï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ªid_rsa.pubå…¬é’¥ï¼ˆè¿™ä¸ªæ¯”ç¬¬ä¸€ä¸ªçŸ­ä¸€äº›ï¼‰
  * å…¶å®åªæ˜¯éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå°†æœ¬åœ°çš„id_rsa.pubçš„å†…å®¹æ·»åŠ åˆ°./ssh/authorized_keyså½“ä¸­å³å¯ 
    * ç”¨```echo XXX >> authorized_keys``` è¿™ç§å½¢å¼
* If after loading keys, logging still requires passwd for eva-8/9
  * Try ```ssh-copy-key -i id_rsa.pub proxy-evaX```
* å¯ä»¥é€šè¿‡æ·»åŠ  - å°†æœåŠ¡å™¨ç«¯å£æ˜ å°„åˆ°æœ¬åœ° 
  * ``LocalForward 127.0.0.1:$PORT_ON_SERVER 127.0.0.1:$LOCAL_PORT```
  * ç­‰æ•ˆäº```ssh -L 16379:127.0.0.1:6379 user@host```
  * åå‘çš„è¯å¯ä»¥ç”¨RemoteHost
* sshçš„configç›¸å…³çš„é…ç½®ç”¨```man ssh_config```å¯ä»¥æŸ¥è¯¢
  * -L è¡¨ç¤ºLocalForward - å°†æœ¬åœ°ç«¯å£æ˜ å°„åˆ°è¿œç«¯
  * -R è¡¨ç¤ºRemoteForward - å°†è¿œç¨‹ç«¯å£æ˜ å°„åˆ°æœ¬åœ°
* Githubé…ç½®proxyåŠ é€Ÿclone
  1. æœ¬åœ°çš„v2rayåœ¨10809çš„ç«¯å£ä¸Šå¼€å¯äº†httpæœåŠ¡
  2. é€šè¿‡ç«¯å£æ˜ å°„åœ¨ç™»å½•æœåŠ¡å™¨çš„æ—¶å€™æŒ‡å®š ssh -R 12450:localhost:10809 å»ºç«‹remoteçš„æ˜ å°„
     * ç«¯å£æ˜ å°„-Lä¼šå‡ºé—®é¢˜ï¼Œä¸æ˜åŸå› 
  3. åœ¨gitçš„configä¸­è¿™æ ·å†™  ```[http] proxy=http://127.0.0.1:12450```
     * åœ¨ssh_configå½“ä¸­å¯ä»¥ ```RemoteForward 127.0.0.1:12450(port on remote) 127.0.0.1:10809```
* æ¸…åæ ¡å›­ç½‘å‡†å…¥æœåŠ¡å™¨ï¼š
  * ä»userregè¿˜æ˜¯å¤ªéº»çƒ¦äº†
  * ä½¿ç”¨æ›´æ–°ä¹‹åçš„[auth-thu](https://github.com/z4yx/GoAuthing)ï¼Œç›´æ¥ä»releaseä¸­ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶åç›´æ¥è°ƒç”¨ ```./auth-linux_x86_64 auth```è¾“å…¥ç”¨æˆ·åå¯†ç å°±å¯ä»¥äº†
* æ³¨æ„SSH configä¸­çš„`LocalForward`å‰é¢çš„æ˜¯æœ¬åœ°çš„IPï¼Œå¯ä»¥ä¸ç”¨åŠ localhost

---


## è”ç½‘ç›¸å…³(ç™»å½•æœåŠ¡å™¨)

> è”ç½‘çœŸçš„æ˜¯ä¸€ä»¶å¾ˆè´¹åŠ²çš„äº‹æƒ…

* å¯èƒ½ä¼šå‡ºç°ç™»å½•ä¸ä¸ŠæœåŠ¡å™¨çš„æƒ…å†µ
  * å¤§æ¦‚ç‡æ˜¯å› ä¸ºæ²¡æœ‰å‡†å…¥

### å‡†å…¥Tips

1. å¯¹äºä¸åœ¨ç½—å§†æ¥¼ç½‘æ®µçš„æœåŠ¡å™¨(eva8/9/10)ï¼Œæˆ‘ä»¬ä¸€èˆ¬åœ¨ä¸»æœº(eva8.nics.cc)ä¸Šçš„32222ç«¯å£ä¼šrouteåˆ°è¿™å°evaæ‰€å¯¹åº”çš„è·³æ¿æœº(proxy.eva8.nics.cc),è¯¥è·³æ¿æœºä¼šåŒæ—¶åœ¨ç½—å§†æ¥¼ä¸å…¶ä»–æœåŠ¡å™¨æ‰€åœ¨ç½‘æ®µ(å¦‚ä¼Ÿæ¸…æ¥¼)ï¼Œåœ¨è·³æ¿æœºä¸Šå¯ä»¥ç™»å½•åˆ°å„ä¸ªcontainer

   * eva8ä¸»æœº(IP: eva8.nics.cc); eva8-proxy(IP: proxy.eva8.nics.cc); eva8çš„container(IP: foxfi.eva8.nics.cc) ä¸‰è€…IPéƒ½ä¸ä¸€æ ·ï¼Œä¸‰è€…å¦‚æœå°†å…¶IPç›´æ¥é€šè¿‡useregå‡†å…¥ï¼Œå°±å¯ä»¥ç›´æ¥ç™»å½•

   * ç™»å½•ä¸åœ¨åŒä¸€ç½‘æ®µçš„æœºå™¨éœ€è¦åœ¨cfgé‡Œé¢å¤–æœ‰ä¸€ä¸ª   

     ```
     Host proxy-eva8:
     	HostName: eva8.nics.cc
     	Port: 32222
     	User: 
     	Proxy: xxx
     	
     Host proxy-eva8:
     	HostName: proxy.eva8.nics.cc
     	User: 
     	Proxy: xxx
     ```

     * è¿™ä¸ªcfgå®šä¹‰äº†eva8ä¸­çš„è·³æ¿æœºï¼Œå…¶æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªcontainerï¼Œå¼€åœ¨ä¸»æœºçš„32222ç«¯å£(ä¸»æœºé€šè¿‡ä¿®æ”¹è·¯ç”±NATè¡¨è‡ªåŠ¨å°†åŒ…éƒ½è½¬å‘åˆ°äº†proxy containeræ‰€åœ¨çš„IP) - æ‰€ä»¥å°†ä¸»æœºå‡†å…¥æˆ–è€…æ˜¯å°†proxyæ‰€åœ¨çš„containerå‡†å…¥ï¼Œéƒ½å¯ä»¥å°†å…¶è¿å…¥æ¸…åå†…ç½‘ï¼›proxy containerå°†å„ä¸ªeva containerä¸evaä¸»æœºé€šè¿‡å†…ç½‘è¿æ¥(ä¸ç”¨æ¯ä¸ªcontaineréƒ½å‡†å…¥ï¼Œéƒ½å¯ä»¥é€šè¿‡è¿™æ ·è·³è½¬)
     * å½“é‡å¯ä¹‹åï¼Œåªè¦å°†ä¸»æœºå…¥ç½‘ï¼Œå°±å¯ä»¥è®©æ‰€æœ‰çš„containeré€šè¿‡æ–¹å¼Aç™»å½•äº†ã€‚

2. è¿å¤–ç½‘

   * ä¸€ç§æ˜¯useregç›´æ¥è¾“å…¥ip
   * ä¸€ç§æ˜¯å‡†å…¥```~/auth-thu.linux.x86_64 auth```

3. å¤šæœåŠ¡å™¨ä¹‹é—´æ‹·è´æ–‡ä»¶

   * æ³¨æ„ä¸€ä¸‹å¯èƒ½åœ¨cfgä¸­æœ‰å…³äºåŸŸåçš„alias


### SCP

* `zhaotianchen@foxfi-eva8:~$ scp ztc.eva7.nics.cc:/home/zhaotianchen/awnas/data/modelnet40_normal_resampled.zip ./`
* æŸæ¬¡å‡ºç°äº†æ— è®ºæ€ä¹ˆå‡†å…¥éƒ½æ— æ³•pingé€šçš„æƒ…å†µï¼Œå‘ç°æ˜¯eva7çš„æŸä¸ªcontainerçš„IP tableå‡ºäº†é—®é¢˜ï¼Œåˆ é™¤æ‰æŸæ¡ruleä¹‹åå¥½äº†
  * ä½¿ç”¨`route`å‘½ä»¤ï¼Œæ‰¾åˆ°ä¸€ä¸ªdefaultçš„è·¯ç”±ï¼Œgwæ˜¯10å¼€å¤´çš„ï¼Œæ‰‹åŠ¨åˆ é™¤
  * `sudo route del default gw 10.0.3.1`
* ![image-20210410105419818](C:\Users\A-suozhang\AppData\Roaming\Typora\typora-user-images\image-20210410105419818.png)

1. å„ä¸ªæœåŠ¡å™¨ä¸­é—´å¯èƒ½å­˜æ•°æ®é›†çš„åœ°æ–¹

   * åªæœ‰eva7æ˜¯`/data/eva_share_users`ï¼Œå…¶ä»–çš„åŸºæœ¬éƒ½æ˜¯`/home/eva_share_users`


### å¼€æœºè‡ªå¯åŠ¨

* [Linuxå¼€æœºè‡ªåŠ¨åŒ–æ‰§è¡Œè„šæœ¬çš„å››ç§æ–¹æ³•ï¼ˆçœŸå®æ¡ˆä¾‹åˆ†äº«ï¼‰_æ¸…é£é˜-CSDNåšå®¢_linuxå¼€æœºè‡ªåŠ¨è¿è¡Œè„šæœ¬](https://blog.csdn.net/abc_12366/article/details/87552848)

## CUDA Stuff

* å¦‚æœsmiä¸å‡ºæ¥ä¸œè¥¿äº†å»/opt/cuda-x.xä¸­æ‰§è¡ŒdeviceQuery(å¯èƒ½éœ€è¦sudo)

* é€šè¿‡åœ¨bashä¸­ç”¨ LD_LIBRARY_PATHæ¥æŒ‡å®šç”¨ä»€ä¹ˆcuda

  * å¦‚æœä¸ºç©ºçš„è¯å°±ä¼šæŸ¥è¯¢ PATH, é‡Œé¢ä¸€èˆ¬æœ‰ ```/usr/lib/cuda```, æŸ¥è¯¢ä¹‹ååº”è¯¥åœ¨evaæœåŠ¡å™¨ä¸­æ˜¯ä¸€ä¸ªè½¯è¿æ¥è¿æ¥åˆ°äº†/opt/cudaé‡Œ

  * $PATHå˜é‡æœ¬èº«é€šè¿‡"ï¼š"åˆ†éš”,åé¢çš„è¦†ç›–ï¼Œå¸¸ç”¨çš„æ–¹å¼ ```PATH=PATH:some_new_path```


## Install  a few stuff

* å¬ä»[åˆä»£ç›®ç½‘ç®¡çš„æ„è§](https://nicsefc.ee.tsinghua.edu.cn/wiki/dl:install)ï¼Œå®‰è£…MiniConda3
  * æ–‡ç« ä¸­ï¼Œcondaå…¬å¸å’ŒIntelæœ‰pyï¼Œä»å®ƒè¿™é‡Œä¸‹çš„åŒ…CPUè®¡ç®—ä¼šæ›´å¿«è¯´æœäº†æˆ‘ï¼ˆ~~è™½ç„¶ä¸çŸ¥é“åˆ°åº•æœ‰å¤šçœŸå®~~ï¼‰
  * è€Œä¸”condaä¹Ÿå’Œpipå…¼å®¹ï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢
  * ä¹‹å‰ä¸è£…condaæ˜¯å› ä¸ºå®ƒèµ·æ‰‹å°±å®‰äº†ä¸€ä¸‡ä¸ªåŒ…ï¼ŒåŸæ¥æ˜¯æˆ‘æ²¡æœ‰å‘ç°miniconda

```
wget https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-x86_64.sh
chmod +x Miniconda3-latest-Linux-x86_64.sh
./Miniconda3-latest-Linux-x86_64.sh

// æ‰“å¼€ä¸€ä¸ªæ–°çš„Shell(é‡æ–°ç™»å½•ä¸€æ¬¡)

conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --set show_channel_urls yes
```

* å®‰è£…äº†shadowsocksä¸Proxychainsæ¥åŠ å¿«git cloneé€Ÿåº¦

* å®‰è£…opencv
  * ```conda install python-opencvå¤±è´¥```
    * ```pip3 install python-opencv```å®‰è£…ä¸ä¸Š
    * å®‰è£…äº†condaä¹‹åï¼Œå¯¹åº”çš„pythonæ˜¯pipå¯¹åº”çš„ï¼Œè€Œpip3å¯¹åº”çš„æ˜¯è€çš„python3
  * ä¸­é—´æŠ¥äº†  ```å®‰è£…opencvæ—¶æŠ¥é”™ ImportError: libXrender.so.1: cannot open shared object file: No such file or directory```
    * ç›´æ¥ ```sudo apt-get install libxrender1```

* å®‰è£…tmuxå¹¶é…ç½®
  * æŒ‰ç…§ç½‘ç®¡ç»™çš„tmux.confå¯åŠ¨
  * *ä¿®æ”¹ä¸€ä¸‹tmuxçš„å¿«æ·é”®prefix(CTRL+Bå®åœ¨æ˜¯å¤ªè¿œäº†,æ”¹æˆ+xå§)*
    * æŸ¥çœ‹ç°åœ¨çš„Prefix Binidng```tmux show-options -g | grep prefix```
    * åœ¨~/.tmux.confä¸­åŠ ä¸Š
      ```
       set -g prefix C-x
       unbind C-b
       bind C-x send-prefix
      ```
    * ä½¿å…¶ç”Ÿæ•ˆ:
      * åœ¨tmuxä¸­ CTRL+B+(æ­¤æ—¶è¿˜æ²¡æœ‰æ”¹å¥½)): è¾“å…¥source-flie ~/.tmux.conf
      * è¿™ä¹‹åçš„éƒ½okäº†


* å¯¹vimçš„å®‰è£…å’Œé…ç½®è§[Ubuntuç³»ç»Ÿé…ç½®ï¼](http://a-suozhang.xyz/2020/01/08/UbuntuSetup/)

* Pytorchçš„å®‰è£…


  * æœ‰çš„æ—¶å€™ä¼šæ— æ³•è‡ªåŠ¨åŒ¹é…åˆ°æ‰€éœ€è¦çš„cudaç‰ˆæœ¬ï¼Œæˆ–è€…æ˜¯è‡ªåŠ¨å®‰è£…äº†æ›´æ–°ç‰ˆæœ¬çš„pytorchè€Œå¯¼è‡´æ— æ³•cuda()
  * ck CUDA ç‰ˆæœ¬`echo $PATH; echo $LD_LIBRARY_PATH`
  * å¼ºåˆ¶forceå®‰è£…æŸä¸ªç‰ˆæœ¬ `pip install torch==1.7.0`

    * ä½†æ˜¯å³ä½¿è¿™æ ·æœ‰æ—¶å€™tuna mirroræ‰¾ä¸åˆ°å½“å‰ç‰ˆæœ¬ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦`pip install torch==1.7.1+cu101 -f https://download.pytorch.org/whl/torch_stable.html`è¿™æ ·é‚£ç›´æ¥ä»pytorchå®˜æ–¹çš„stableæºæ¥ä¸‹è½½

* eva0ä¸Šnvccè²Œä¼¼æ²¡æœ‰ç»“æœ(ä¸çŸ¥é“æ˜¯ä¸æ˜¯å’Œæœ‰å¥½å‡ ä¸ªcontainerç›¸å…³)
  * æŒ‰ç…§bingåˆ°çš„ç»“æœå»çœ‹ /usr/local/cudaä¸‹çš„version.txtè²Œä¼¼ä¹Ÿä¸æ˜¯å¾ˆè¡Œ
  * å’¨è¯¢äº†ç½‘ç®¡ä¹‹åçš„ç»“æœ
    * åœ¨/opt/cuda-10.0ç›®å½•åº•ä¸‹æœ‰ç€cuda
    * *æµ‹è¯•cudaæ˜¯å¦èƒ½ç”¨*
      
      * è¿è¡Œ/opt/cuda-10.0/samples/1_Utilities/deviceQuery/ä¸‹çš„deviceQueryå¯æ‰§è¡Œæ–‡ä»¶
      * **å¼€æœºä¹‹åè¦é¦–å…ˆè¿è¡Œä¸€æ¬¡è¿™ä¸ªè„šæœ¬ï¼Œå¦åˆ™cudaå°±ç”¨ä¸äº†ï¼**
      * æ­£ç¡®çš„ç°è±¡
        
        * ![](https://github.com/A-suozhang/MyPicBed/raw/master/img/20191021215750.png)
      * åŒæ—¶ç»™å‡ºnvidia-smiç»“æœ
        
        * ![](https://github.com/A-suozhang/MyPicBed/raw/master/img/20191021200015.png)
      * åœ¨pytorchå®˜ç½‘é€‰æ‹©å®‰è£…: Conda-Python3.7-cuda10.1
        
        * *å¤§æ¦‚800Mçš„ä¸‹è½½ä¹‹åå°±å®‰è£…å¥½äº†*
      * æµ‹è¯•cuda okæ²¡æœ‰
      
        ``` python
        import torch
        torch.cuda.is_available()
        ```


* ğŸ› Matplotlib.pyplot importçš„æ—¶å€™æŠ¥é”™äº† 
    ```
    This application failed to start because it could not find or load the Qt platform plugin "xcb"in "".
    Available platform plugins are: eglfs, minimal, minimalegl, offscreen, vnc, xcb.
    Reinstalling the application may fix this problem.
    ```
    * åŸå› æ˜¯ç¼ºå°‘äº†Qtçš„æ”¯æŒ
      * [åœ¨è¿™é‡Œæ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆ ]](https://github.com/OpenShot/openshot-qt/issues/1809)
      
      * ```sudo apt-get install libqt5gui5```
      
## SSH é…ç½®ç›¸å…³-deprecated

> deprecated

* é‚£ä¹ˆå¦‚ä½•ç™»å½•evaå‘¢ï¼Ÿ
  * é…ç½®äº†Linuxç¯å¢ƒä¸‹é€šè¿‡è·³æ¿æœºç›´æ¥è®¿é—®ç›®æ ‡æœºå™¨
    * ä¸€æ¬¡sshè€Œä¸æ˜¯ä¸¤æ¬¡
    * ä¸»è¦å‚è€ƒäº†[è¿™ç¯‡æ–‡ç« ](https://blog.csdn.net/DiamondXiao/article/details/52474104)
    * åœ¨.bashrcé‡Œé¢åŠ ä¸Š
    ``` bash
      alias eva="ssh zhaotianchen@101.6.64.144 -p 22 -o ProxyCommand='ssh -p 42222 zhaotianchen@101.6.64.67 -W %h:%p'"
      alias fpga="ssh ztc@fpga1.nics.cc -p 22 -o ProxyCommand='ssh -p 42222 zhaotianchen@101.6.64.67 -W %h:%p'"
    ```
  * æŒ‰ç…§ä¸Šé¢çš„é…ç½®ä¹‹åè¿˜éœ€è¦å†è¿›è¡Œä¸€æ¬¡ç§˜é’¥copy
    * ```ssh-copy-id  -i id_rsa.pub zhaotianchen@101.6.64.144 -p 22 -o ProxyCommand='ssh -p 42222 zhaotianchen@101.6.64.67 -W %h:%p'```
    * è¯´æ˜ä»è·³æ¿æœºç™»å½•ï¼ˆ2æ¬¡ï¼‰éœ€è¦çš„ç§˜é’¥å’Œä¸€æ¬¡çš„éœ€è¦æ˜¯ä¸ä¸€æ ·çš„
    * fpga1.nics.cc -> 101.6.68.236(ç”±äºç”¨ssh configæ–‡ä»¶è¿™ç§æ–¹å¼ç™»å½•çš„è¯ä¸èƒ½ç”¨åŸŸå)

* æœåŠ¡å™¨çš„è·³æ¿æœºä¸€å®šè¦ä»ä¸€å®šç«¯å£ç™»å½•ï¼Œä¸ç„¶å°±ç™»å½•Permission denied
	
* æ¯”å¦‚è¯´eva10.nics.ccå¿…é¡»è¦ä»32222 portè®¿é—®
	
* å…³äºå…å¯†ç ç™»å½•
	* æœ¬æœºçš„.sshæ–‡ä»¶å¤¹é‡Œæœ‰ä¸€å¯¹å¯†é’¥ï¼Œid_rsa.pubå’Œid_rsa
	* å…¶ä¸­æ‰§è¡Œ```ssh-copy-id -i id_rsa.pub $SERVER_NAME```å®é™…å®Œæˆçš„æ“ä½œå°±æ˜¯æŠŠid_rsa.pubé‡Œé¢çš„ä¸œè¥¿å¤åˆ¶åˆ°æœåŠ¡å™¨ä¸Šçš„.ssh/authorized_keysé‡Œé¢
		* ç”±äºwinå¹¶æ²¡æœ‰ssh-copy-id å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥ç™»å½•æœåŠ¡å™¨æ‰‹åŠ¨é…ç½®ï¼Œæˆ–è€…æ˜¯ç”¨scpæŠŠauthorized_keysç»™ä¼ ä¸Šå»(åœ¨winä¸‹vimä¸å¥½ä½¿çš„æƒ…å†µä¸‹)
		* æ³¨æ„scpæŒ‰ç…§portæ¥ä¼ è¾“çš„å‘½ä»¤æ˜¯```scp -P xxx```
	* å®Œæˆå¤åˆ¶ä¹‹åï¼Œä»**æœ‰ç§é’¥çš„æœåŠ¡å™¨**ç™»å½•åˆ°æ–°çš„æœåŠ¡å™¨ï¼Œå¯ä»¥ç›´æ¥å…å¯†ç ç™»å½•ï¼ˆä½†æ˜¯æ³¨æ„æ²¡æœ‰ç§é’¥çš„åœ°æ–¹è¿˜æ˜¯ä¸è¡Œï¼Œæ‰€ä»¥ä»ä¸­é—´èŠ‚ç‚¹ç›´æ¥è¿æœ€åæ˜¯ä¸è¡Œçš„ï¼‰
	* å…¶ä»–çš„æ¯”å¦‚known_hostsä»€ä¹ˆçš„å…¶å®ä¸ç”¨æ”¹ä¹Ÿå¯ä»¥

* ~~Tensorboardè¿œç¨‹æ˜ å°„~~ï¼ˆDeprecatedï¼‰ Use ```ssh -L 10808:localhost:127.0.0.1 ztc.eva10``` 
  * [é€šè¿‡è·³æ¿æœºæŸ¥çœ‹å†…ç½‘æœåŠ¡å™¨çš„tensorbord](https://blog.csdn.net/Woody0729/article/details/80933014)
  * é…ç½®æ–°çš„ç™»å½•Evaçš„æ–¹å¼(ä»¥æ”¯æŒç«¯å£ä¼ æ’­,ä»è€Œçœ‹åˆ°Tensorboard)
    * éœ€è¦ç™»å½•ä¸¤æ¬¡,é¦–å…ˆç™»å½•è·³æ¿æœº with
      * ```ssh -L 16006:127.0.0.1:8008 account@è·³æ¿æœºip```
    * ç„¶ååœ¨è·³æ¿æœºä¸Šç™»å½•with 
      * ```ssh -L 8008:127.0.0.1:6006 account@æœåŠ¡å™¨ip```
    * æœ€åç›´æ¥åœ¨æœ¬åœ°æœºå™¨ä¸Šçš„localhost:16006è§‚å¯Ÿç»“æœ
    * *æ³¨æ„è¿™è¾¹å¯èƒ½åˆ·æ–°å’ŒLoadä¼šæœ‰ä¸€å®šçš„å»¶è¿Ÿ,ç¨å¾®ç­‰ä¸€ä¼šTensorboardçš„å†…å®¹ä¼šé€æ¸loadå‡ºæ¥*

* å¦‚æœX11 Forwardingå‡ºäº†é—®é¢˜,æ‰“ä¸å¼€matplotlib,å¯ä»¥å…ˆ

```
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
```


---

* [blog-1](https://deepzz.com/post/how-to-setup-ssh-config.html)
* [blog-2](https://mdgsf.github.io/2019/08/01/linux-ssh-study/)


---

# Ray Setup

1. å®‰è£…ray
2. æŒ‰ç…§scripts/python rayå¤‡æ³¨ä¸­çš„æ ¼å¼è®¾ç½®ray(æ¯ä¸ªæœºå™¨æˆ–è€…conda envåªéœ€è¦è®¾ç½®ä¸€æ¬¡)
	* éœ€è¦è®°å½•ä¸‹ä¸€ä¸ªredis-dir
	* ![](https://github.com/A-suozhang/MyPicBed/raw/master/img/20200104165140.png)
3. æ–°å»ºä¸€ä¸ªexperimentæ–‡ä»¶å¤¹,å†…éƒ¨è¯´æ˜æ–¹æ³•çš„åå­—
4. å†™ä¸€ä¸ªè„šæœ¬ç”Ÿæˆæ–°çš„yamlæ–‡ä»¶,æ”¾ç½®åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹
5. è°ƒç”¨è„šæœ¬ python train_ray.py --redisdir=XXX $PATH_TO_YAML_DIR
	* åˆ™ä¼šè‡ªåŠ¨loadä¸‹dirç›®å½•ä¸‹çš„æ¯ä¸ªyamlæ–‡ä»¶
	* æ¯å½“ä¸€ä¸ªå®éªŒå®Œæˆä¹‹åä¼šè‡ªåŠ¨å»ºç«‹ä¸€ä¸ªè¿›ç¨‹å°†æ–°çš„å®éªŒæ·»åŠ è¿›å»
	* æœ‰ä¸¤ä¸ªå¿…é¡»çš„arg
		* redis-addr å¯åŠ¨rayæ—¶å€™ä¼šç»™çš„åœ°å€
		* result-base-dir å­˜æ”¾logçš„åœ°å€
			* ä¼šè‡ªåŠ¨appendä¸Šè¿™æ¬¡è°ƒæ•´çš„å‚æ•°çš„åå­—(ä¹Ÿå°±æ˜¯experimentçš„yaml settingæ‰€åœ¨çš„dirå‰é¢ä¸€å±‚)
		* å†åé¢å°±æ˜¯æ­£å¸¸mainå‡½æ•°çš„yamlæ‰€åœ¨çš„æ–‡ä»¶å¤¹,ä¼šè¯»å–è¯¥æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰yamlå¹¶ä¸”è·‘

* è®°ä¸ä½redis-addræ€ä¹ˆåŠ,å› ä¸ºæ¯ä¸€æ¬¡start rayçš„æ—¶å€™ä¼šéšæœºäº§ç”Ÿä¸€ä¸ª,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ª,åœ¨rayçš„å‘½ä»¤é‡Œ
	* ```alias ray-start="CUDA_VISIBLE_DEVICES=0,1,2,3 ray start --head --num-cpus 10 --num-gpus 4 --object-store-memory 10000000 --redis-port=12450```

---

# Conda Virtual Env

* ```conda create -n $NAME python=3.7```
	* æœ€å¥½ç›´æ¥åœ¨æœ€åç”¨python=3.7ï¼Œè¿™æ ·ä¼šç›´æ¥åœ¨å½“å‰ç¯å¢ƒä¸‹ç”Ÿæˆä¸€ä¸ªç¯å¢ƒ```miniconda3/envs/$NAME/bin/python```ï¼Œæ›´åŠ ä¸å®¹æ˜“å’Œglobalçš„pythonæèµ·æ¥
	* ç„¶åpipåº”è¯¥ä¹Ÿæ˜¯å®‰è£…åˆ°äº†å¯¹åº”ä½ç½®ä¸ç”¨ä¿®æ”¹ï¼Œç„¶åç”¨```pip install ipython```
	* å®‰è£…å®Œæˆä¹‹åè™½ç„¶```which ipython```æ­£ç¡®ï¼Œå†…å®¹ä¹Ÿæ­£ç¡®ï¼Œä½†æ˜¯è¾“å…¥ipythonè¿˜æ˜¯globalçš„ - éœ€è¦**decativateå†é‡æ–°ç™»å½•è™šæ‹Ÿç¯å¢ƒä»¥reloadç¯å¢ƒ**
* ```conda deactivate``` é€€å‡ºç°æœ‰ç¯å¢ƒ
* ```conda info -e``` æŸ¥çœ‹ç°æœ‰çš„ç¯å¢ƒ
* ```conda remove -n $NAME --all```
* ```conda create -n $NEW --clone $OLD; conda remove -n $OLD --all```

* æœ‰çš„æ—¶å€™æ›´æ–°äº†ç¯å¢ƒä¹‹åè¿˜pipè¿˜æ˜¯æŒ‡å‘äº†baseé‡Œé¢çš„pip
	* è¿™ä¸ªæ—¶å€™decativateä¸€ä¸‹ç„¶åå†activateå°±å¯äº†
	* æ³¨æ„ä¸€å®šè¦deactivateå†activateï¼Œå…³æ‰panelå†activateå¥½åƒæ˜¯æ²¡ç”¨çš„(è²Œä¼¼ä¸æ˜¯ä¸€ç›´work)
		* ç°åœ¨å±…ç„¶æ˜¯å…ˆè¾“å…¥ä¸€ä¸ªé”™çš„conda envåå­—ç„¶åå†è¾“å…¥å°±å¥½äº†â€¦â€¦(äººç±»è¿·æƒ‘)

* æœ‰çš„æ—¶å€™ä¼šå‡ºç°æ— è®ºæ“ä½œä»€ä¹ˆéƒ½segmentation faultçš„æƒ…å†µ(ç”šè‡³é‡è£…condaä»¥åŠæ›´æ–°conda)
  * è¿™ä¸ªæ˜¯å¶ç”¨```conda clean -a```æ¥æ¸…æ¥šæœ¬åœ°çš„ç¼“å­˜(å¯èƒ½æ˜¯å› ä¸ºä¸­é€”ç½‘ç»œé”™è¯¯å¯¼è‡´çŠ¶æ€å´©é¢“)
  * [å±…ç„¶æ˜¯ä¸€ä¸ªCSDNçš„blogæ•‘äº†æˆ‘](https://blog.csdn.net/u012110870/article/details/103800701)


* å¦‚æœéœ€è¦renameä¸€ä¸ªenvçš„è¯
	* éœ€è¦å¤åˆ¶ä¸€ä¸ªæ–°ç¯å¢ƒ ```conda create --name NEW_NAME --clone OLD_NAME```
	* ç„¶ååˆ é™¤è€çš„ç¯å¢ƒ ```conda remove --name OLD_NAME --all```

* deäº†ä¸€ä¸ªipythonç¯å¢ƒçš„bugï¼Œä¸€å¼€å§‹çš„é”™è¯¯æç¤ºæ˜¯åœ¨ç¯å¢ƒä¸­ä»ç„¶ä½¿ç”¨äº†baseç¯å¢ƒçš„ipython
  * ç”±äº$PATHå†…éƒ¨.local/binåœ¨conda/env/xxxçš„å‰é¢ã€‚æ‰€ä»¥ä¼˜å…ˆè°ƒç”¨äº†baseç¯å¢ƒä¸‹çš„ipython
  * æ£€æŸ¥bashrcçš„æ—¶å€™å‘ç°å¹¶æ²¡æœ‰.local/binè¿™ä¸ªä¸œè¥¿ï¼Œç„¶åå‘ç°æ˜¯åœ¨~/.profileå½“ä¸­æ”¹åŠ¨äº†$PATHï¼Œå°†.local/binæ”¾åˆ°PATHçš„æœ€å
  * **åŸºæœ¬condaç¯å¢ƒä¸­å¯¹ä¸ä¸Šçš„æƒ…å†µï¼ŒåŒ…æ‹¬pipå’Œpythonï¼Œéƒ½æ˜¯$PATHçš„é—®é¢˜ï¼Œå…¶è¿è¡Œå‡†åˆ™æ˜¯ä¼˜å…ˆåŒ¹é…å‰é¢çš„**

* [pack and move a conda env](https://superuser.com/questions/1287428/cant-rebind-ctrl-b-to-ctrl-a-in-tmux)



## æºç ç¼–è¯‘TF

> following [official guide](https://www.tensorflow.org/install/source)

1. å®‰è£…prequisite

``` py
pip install -U --user pip six numpy wheel setuptools mock 'future>=0.17.1'
pip install -U --user keras_applications --no-deps
pip install -U --user keras_preprocessing --no-deps
```

2. å®‰è£…[bazel](https://docs.bazel.build/versions/master/install-ubuntu.html)
  * **æ³¨æ„éœ€è¦æŸ¥çœ‹ä¸€ä¸‹bazelçš„ç‰ˆæœ¬ï¼Œåœ¨tensorflowæºç çš„configure.pyä¸­æœ‰ç€å¯¹åº”ç‰ˆæœ¬æ‰€èƒ½æ¥å—çš„bazelç‰ˆæœ¬**
  * å»ºè®®ç›´æ¥ä»å®˜ç½‘ï¼Œä»¥åŠ[å®˜æ–¹git repo](https://github.com/bazelbuild/bazel/releases)ä¸‹è½½binaryå®‰è£…åŒ…å®‰è£…
  * ```chmod +X ./bazel-xxx```
  * ```./bazel-xxx --user```
    * æ³¨æ„è¿™é‡Œçš„--userå¾ˆå…³é”®ï¼Œä¼šåŠ å…¥ç¯å¢ƒå˜é‡ï¼Œå¹¶ä¸”é»˜è®¤æ˜¯å°†å½“å‰ç‰ˆæœ¬çš„bazelå®‰è£…åˆ°```~/bin/bazel```
  * éœ€è¦åœ¨bashrcä¸­åŠ ä¸€è¡Œ
    * ```export PATH="$PATH:$HOME/bin"```
  * è¿˜æœ‰ä¸€ç§æ›¿ä»£æ–¹æ¡ˆï¼Œç›¸å½“äºæ˜¯bazelçš„ç¼–è¯‘å®Œçš„ç‰ˆæœ¬[bazelisk](https://github.com/bazelbuild/bazelisk)ä¸ªäººæ²¡æœ‰å°è¯•
    * å…¶ä½¿ç”¨åº”è¯¥æ˜¯æ›¿æ¢bazelçš„ï¼Œå¯ä»¥ç›´æ¥åœ¨bashrcä¸­```alias bazel=$PATH_TO_BAZELISK```

3. ä¸‹è½½tfæºç 
  * (å…¶å®å¯èƒ½åº”è¯¥æ”¾åœ¨å®‰è£…bazelä¹‹å‰)
  * ```git clone https://github.com/tensorflow/tensorflow.git```
  * åˆ‡æ¢åˆ°æƒ³è¦çš„åˆ†æ”¯ï¼Œé»˜è®¤ä¸ºæœ€æ–°çš„masteråˆ†åª```git checkout branch_name  # r1.9, r1.10```

4. é…ç½®Build
  * ```./configure``` - åˆ«çš„éƒ½æ— æ‰€è°“å¯ä»¥é»˜è®¤ï¼Œå°±æ˜¯è¦æŒ‡å®šä¸€ä¸‹CUDAçš„ä½ç½®```/opt/cuda-10.0```
  * ç»è¿‡configureä¹‹åçš„å†…å®¹æ˜¯åœ¨
  * æœ‰å‡ ä¸ªé¢„è®¾çš„bazel buildæŒ‡ä»¤
    * ```--config=mkl```
    * ```--config=v1``` 

5. ç¼–è¯‘(æœ€å¯èƒ½å‡ºé”™çš„ä¸€èŠ‚)
* ç»è¿‡æˆ‘è‡ªå·±çš„ä½“éªŒï¼Œè²Œä¼¼checkoutåˆ°è€ç‰ˆæœ¬è¿›è¡Œç¼–è¯‘å®¹æ˜“å‡ºé—®é¢˜(æ€»ä¹‹æˆ‘æ˜¯å¤±è´¥äº†)
* é»˜è®¤çš„TF-2.0ç¼–è¯‘ ```bazel build //tensorflow/tools/pip_package:build_pip_package```
  * å¯¹masteråˆ†æ”¯ç¼–è¯‘1.xç‰ˆæœ¬ ```bazel build --config=v1 //tensorflow/tools/pip_package:build_pip_package```
  * CUDAç‰ˆæœ¬ ```bazel build --config=opt --config=cuda //tensorflow/tools/pip_package:build_pip_package```
    * ä¸Šæ¬¡è·‘è¿™ä¸ªæ˜¯å¤±è´¥äº†
* æ³¨æ„å¦‚æœéœ€è¦åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ç¼–è¯‘å¤šæ¬¡tfï¼Œéœ€è¦æ‰§è¡Œ```bazel clean```
* è¯¥æ­¥éª¤ç”Ÿæˆäº†ä¸€ä¸ª```build_pip_package```çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸‹ä¸€æ­¥ä½¿ç”¨

6. ç”Ÿæˆwhl
* è¿™ä¸€æ­¥è²Œä¼¼ä¸å®¹æ˜“å‡ºé—®é¢˜
* ```./bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg```
  * å®˜æ–¹è¯´å¦‚æœæ˜¯æœ€æ–°çš„éœ€è¦åŠ ä¸Šä¸€ä¸ªnightly flagï¼Œ```./bazel-bin/tensorflow/tools/pip_package/build_pip_package --nightly_flag /tmp/tensorflow_pkg```
* ````pip install /tmp/tensorflow_pkg/tensorflow-version-tags.whl```

### å®‰è£…nccl

> ä¸ç¡®å®šå¯èƒ½ç¼–è¯‘å‡ºæ¥çš„tféœ€è¦å®‰è£…è¿™ä¸ªä¸œè¥¿

* [Nvidiaå®˜ç½‘è¿›è¡Œä¸‹è½½](https://developer.nvidia.com/nccl/nccl-download)
  * ä¸‹è½½å¯¹åº”çš„cudaç‰ˆæœ¬ï¼Œéœ€è¦çš„å¹³å°(x86)ï¼Œéœ€è¦çš„å‘è¡Œç‰ˆ(ubuntu 18.04)
  * (å½“å‰NCCLå¥½åƒè¦æ±‚cuda>10.0/cuda-driver>ä¸€å®šç‰ˆæœ¬)
* ```sudo dkpg -i nccl-xxx.deb```å®‰è£…
* æ·»åŠ key ```sudo apt-key add /var/nccl-repo-2.6.4-ga-cuda10.0/7fa2af80.pub```
  * ç”šè‡³æˆ‘æ·»åŠ keyè¿˜å°‘äº†ä¸€ä¸ªåº“ ```sudo apt-get install gnupg```
* ```sudo apt-get update```
* ```sudo apt install libnccl2 libnccl-dev```
* å®‰è£…çš„nccl.håœ¨```/usr/include/nccl.h```

* ç”±äºæˆ‘çš„cudaå¹¶ä¸åœ¨æ ‡å‡†ä½ç½®```/usr/lib```ï¼Œæ‰€ä»¥éœ€è¦åœ¨cudaçš„å¯¹åº”æ–‡ä»¶å¤¹é‡Œåˆ›å»ºä¸¤ä¸ªè½¯è¿æ¥ï¼Œæ‰èƒ½è®©tfçš„configureèƒ½å¤Ÿdetectåˆ°
  * ```/usr/lib/nccl.h``` -> ```$CUDA_PATH/include```
  * ```/usr/lib/x86_64-linux-gnu/libnccl.so.2``` -> ```$CUDA_PATH/LIB64```
### å®‰è£…android studio

* [Tutorial](https://github.com/tensorflow/examples/tree/master/lite/examples/object_detection/android)
* [å®˜ç½‘å®‰è£…]()

