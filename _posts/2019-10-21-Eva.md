---
layout:     post                    # ä½¿ç”¨çš„å¸ƒå±€ï¼ˆä¸éœ€è¦æ”¹ï¼‰
title:      Eva0å¼€å‘ç¬”è®°          # æ ‡é¢˜ 
subtitle:   ï¼ˆå¾…å¡«ä¸€ä¸ªevaæ¢—ï¼‰   #å‰¯æ ‡é¢˜
date:       2020-01-04          # æ—¶é—´
author:     tianchen                      # ä½œè€…
header-img:  img/10_1/bg-eva.jpg  #è¿™ç¯‡æ–‡ç« æ ‡é¢˜èƒŒæ™¯å›¾ç‰‡  
catalog: true                       # æ˜¯å¦å½’æ¡£
tags:                               #æ ‡ç­¾
     - private
---

# EVA å¼€å‘æ—¥è®°


* å¬ä»[åˆä»£ç›®ç½‘ç®¡çš„æ„è§](https://nicsefc.ee.tsinghua.edu.cn/wiki/dl:install)ï¼Œå®‰è£…MiniConda3
  * æ–‡ç« ä¸­ï¼Œcondaå…¬å¸å’ŒIntelæœ‰pyï¼Œä»å®ƒè¿™é‡Œä¸‹çš„åŒ…CPUè®¡ç®—ä¼šæ›´å¿«è¯´æœäº†æˆ‘ï¼ˆ~~è™½ç„¶ä¸çŸ¥é“åˆ°åº•æœ‰å¤šçœŸå®~~ï¼‰
  * è€Œä¸”condaä¹Ÿå’Œpipå…¼å®¹ï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢
  * ä¹‹å‰ä¸è£…condaæ˜¯å› ä¸ºå®ƒèµ·æ‰‹å°±å®‰äº†ä¸€ä¸‡ä¸ªåŒ…ï¼ŒåŸæ¥æ˜¯æˆ‘æ²¡æœ‰å‘ç°miniconda

```
wget https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-x86_64.sh
chmod +x Miniconda3-latest-Linux-x86_64.sh
./Miniconda3-latest-Linux-x86_64.sh

// æ‰“å¼€ä¸€ä¸ªæ–°çš„Shell(é‡æ–°ç™»å½•ä¸€æ¬¡)

conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --set show_channel_urls yes
```

* å®‰è£…äº†shadowsocksä¸Proxychainsæ¥åŠ å¿«git cloneé€Ÿåº¦

* å®‰è£…opencv
  * ```conda install python-opencvå¤±è´¥```
    * ```pip3 install python-opencv```å®‰è£…ä¸ä¸Š
    * å®‰è£…äº†condaä¹‹åï¼Œå¯¹åº”çš„pythonæ˜¯pipå¯¹åº”çš„ï¼Œè€Œpip3å¯¹åº”çš„æ˜¯è€çš„python3
  * ä¸­é—´æŠ¥äº†  ```å®‰è£…opencvæ—¶æŠ¥é”™ ImportError: libXrender.so.1: cannot open shared object file: No such file or directory```
    * ç›´æ¥ ```sudo apt-get install libxrender1```

* å®‰è£…tmuxå¹¶é…ç½®
  * æŒ‰ç…§ç½‘ç®¡ç»™çš„tmux.confå¯åŠ¨
  * *ä¿®æ”¹ä¸€ä¸‹tmuxçš„å¿«æ·é”®prefix(CTRL+Bå®åœ¨æ˜¯å¤ªè¿œäº†,æ”¹æˆ+xå§)*
    * æŸ¥çœ‹ç°åœ¨çš„Prefix Binidng```tmux show-options -g | grep prefix```
    * åœ¨~/.tmux.confä¸­åŠ ä¸Š
      ```
       set -g prefix C-x
       unbind C-b
       bind C-x send-prefix
      ``` 
    * ä½¿å…¶ç”Ÿæ•ˆ:
      * åœ¨tmuxä¸­ CTRL+B+(æ­¤æ—¶è¿˜æ²¡æœ‰æ”¹å¥½)): è¾“å…¥source-flie ~/.tmux.conf
      * è¿™ä¹‹åçš„éƒ½okäº†

* é…ç½®pytorch with cuda
  * eva0ä¸Šnvccè²Œä¼¼æ²¡æœ‰ç»“æœ(ä¸çŸ¥é“æ˜¯ä¸æ˜¯å’Œæœ‰å¥½å‡ ä¸ªcontainerç›¸å…³)
    * æŒ‰ç…§bingåˆ°çš„ç»“æœå»çœ‹ /usr/local/cudaä¸‹çš„version.txtè²Œä¼¼ä¹Ÿä¸æ˜¯å¾ˆè¡Œ
    * å’¨è¯¢äº†ç½‘ç®¡ä¹‹åçš„ç»“æœ
      * åœ¨/opt/cuda-10.0ç›®å½•åº•ä¸‹æœ‰ç€cuda
      * *æµ‹è¯•cudaæ˜¯å¦èƒ½ç”¨*
        * è¿è¡Œ/opt/cuda-10.0/samples/1_Utilities/deviceQuery/ä¸‹çš„deviceQueryå¯æ‰§è¡Œæ–‡ä»¶
        * **å¼€æœºä¹‹åè¦é¦–å…ˆè¿è¡Œä¸€æ¬¡è¿™ä¸ªè„šæœ¬ï¼Œå¦åˆ™cudaå°±ç”¨ä¸äº†ï¼**
        * æ­£ç¡®çš„ç°è±¡
          * ![](https://github.com/A-suozhang/MyPicBed/raw/master/img/20191021215750.png)
        * åŒæ—¶ç»™å‡ºnvidia-smiç»“æœ
          * ![](https://github.com/A-suozhang/MyPicBed/raw/master/img/20191021200015.png)
        * åœ¨pytorchå®˜ç½‘é€‰æ‹©å®‰è£…: Conda-Python3.7-cuda10.1
          * *å¤§æ¦‚800Mçš„ä¸‹è½½ä¹‹åå°±å®‰è£…å¥½äº†*
        * æµ‹è¯•cuda okæ²¡æœ‰
         
          ``` python
          import torch
          torch.cuda.is_available()
          ``` 

* ğŸ› Matplotlib.pyplot importçš„æ—¶å€™æŠ¥é”™äº† 
    ```
    This application failed to start because it could not find or load the Qt platform plugin "xcb"in "".
    Available platform plugins are: eglfs, minimal, minimalegl, offscreen, vnc, xcb.
    Reinstalling the application may fix this problem.
    ```
    * åŸå› æ˜¯ç¼ºå°‘äº†Qtçš„æ”¯æŒ
      * [åœ¨è¿™é‡Œæ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆ ]](https://github.com/OpenShot/openshot-qt/issues/1809)
      * ```sudo apt-get install libqt5gui5```
      * ç„¶åç†è®ºä¸Šå°±å¯ç”¨è¿œç¨‹æœåŠ¡å™¨ç›´æ¥ipythonå¹¶ä¸”ç”¨matplotlibç”»å›¾äº†
      * å°±æ˜¯å“åº”é€Ÿåº¦æœ‰ç‚¹æ…¢å—·(å› ä¸ºæˆ‘è¿˜è·³æ¿äº†ä¸€çº§)
       
* TF-2.0è¿˜ä¸æ”¯æŒPy3.7ï¼ˆ~~LZZSCL~~ï¼‰

## SSH é…ç½®ç›¸å…³

> åœ¨å¦ƒå“¥æ•™æˆæ­£ç¡®å§¿åŠ¿ä¹‹å‰ï¼‰


* é‚£ä¹ˆå¦‚ä½•ç™»å½•evaå‘¢ï¼Ÿ
  * é…ç½®äº†Linuxç¯å¢ƒä¸‹é€šè¿‡è·³æ¿æœºç›´æ¥è®¿é—®ç›®æ ‡æœºå™¨
    * ä¸€æ¬¡sshè€Œä¸æ˜¯ä¸¤æ¬¡
    * ä¸»è¦å‚è€ƒäº†[è¿™ç¯‡æ–‡ç« ](https://blog.csdn.net/DiamondXiao/article/details/52474104)
    * åœ¨.bashrcé‡Œé¢åŠ ä¸Š
    ``` bash
      alias eva="ssh zhaotianchen@101.6.64.144 -p 22 -o ProxyCommand='ssh -p 42222 zhaotianchen@101.6.64.67 -W %h:%p'"
      alias fpga="ssh ztc@fpga1.nics.cc -p 22 -o ProxyCommand='ssh -p 42222 zhaotianchen@101.6.64.67 -W %h:%p'"
    ``` 
  * æŒ‰ç…§ä¸Šé¢çš„é…ç½®ä¹‹åè¿˜éœ€è¦å†è¿›è¡Œä¸€æ¬¡ç§˜é’¥copy
    * ```ssh-copy-id  -i id_rsa.pub zhaotianchen@101.6.64.144 -p 22 -o ProxyCommand='ssh -p 42222 zhaotianchen@101.6.64.67 -W %h:%p'```
    * è¯´æ˜ä»è·³æ¿æœºç™»å½•ï¼ˆ2æ¬¡ï¼‰éœ€è¦çš„ç§˜é’¥å’Œä¸€æ¬¡çš„éœ€è¦æ˜¯ä¸ä¸€æ ·çš„
    * fpga1.nics.cc -> 101.6.68.236(ç”±äºç”¨ssh configæ–‡ä»¶è¿™ç§æ–¹å¼ç™»å½•çš„è¯ä¸èƒ½ç”¨åŸŸå)

* Tensorboardè¿œç¨‹æ˜ å°„
  * [é€šè¿‡è·³æ¿æœºæŸ¥çœ‹å†…ç½‘æœåŠ¡å™¨çš„tensorbord](https://blog.csdn.net/Woody0729/article/details/80933014)
  * é…ç½®æ–°çš„ç™»å½•Evaçš„æ–¹å¼(ä»¥æ”¯æŒç«¯å£ä¼ æ’­,ä»è€Œçœ‹åˆ°Tensorboard)
    * éœ€è¦ç™»å½•ä¸¤æ¬¡,é¦–å…ˆç™»å½•è·³æ¿æœº with
      * ```ssh -L 16006:127.0.0.1:8008 account@è·³æ¿æœºip```
    * ç„¶ååœ¨è·³æ¿æœºä¸Šç™»å½•with 
      * ```ssh -L 8008:127.0.0.1:6006 account@æœåŠ¡å™¨ip```
    * æœ€åç›´æ¥åœ¨æœ¬åœ°æœºå™¨ä¸Šçš„localhost:16006è§‚å¯Ÿç»“æœ
    * *æ³¨æ„è¿™è¾¹å¯èƒ½åˆ·æ–°å’ŒLoadä¼šæœ‰ä¸€å®šçš„å»¶è¿Ÿ,ç¨å¾®ç­‰ä¸€ä¼šTensorboardçš„å†…å®¹ä¼šé€æ¸loadå‡ºæ¥*

---

>  å¦ƒå“¥å‘Šè¯‰äº†æˆ‘æ­£ç¡®çš„æ“ä½œ

* ç°åœ¨çš„æ–°çš„Configæ–‡ä»¶çš„å†…å®¹

```
Host eva
	HostName 101.6.64.169
	Port 22
	User zhaotianchen
	ProxyCommand ssh zhaotianchen@101.6.64.67 -p 42222 -W %h:%p
Host fpga
	HostName 101.6.68.236
	Port 22
	User ztc
	ProxyCommand ssh zhaotianchen@101.6.64.67 -p 42222 -W %h:%p

Host 205
  ForwardAgent yes
  HostName 101.6.64.67
  User zhaotianchen
  Port 42222

Host eva*
  HostName %h.nics.cc
  User zhaotianchen
  ProxyCommand ssh zhaotianchen@205 nc %h %p

Host proxy-eva10
  HostName eva10.nics.cc
  Port 32222
  User zhaotianchen
  ProxyCommand ssh zhaotianchen@205 nc %h %p

Host ztc.eva10
  HostName foxfi-eva10
  User zhaotianchen
  ProxyCommand ssh -p 32222 zhaotianchen@eva10 nc %h %p

Host *.eva*
  HostName %h.nics.cc
  User zhaotianchen
  ForwardAgent yes
  ProxyCommand ssh zhaotianchen@205 nc %h %p

```
* ä¸€äº›è§£é‡Šæ€§çš„æ–‡å­—
	* ncè¡¨ç¤ºä¸è¦å†Proxyåœä¸‹æ¥
	* %h è¡¨ç¤ºäº†HostName
	* %p è¡¨ç¤ºäº†Port
* ç»è¿‡è¿™æ ·çš„ä¸€å¥—é…ç½®åº”è¯¥æ˜¯å¯ä»¥ç”¨```ssh ztc.eva10```è¿™æ ·çš„å‘½ä»¤ç›´æ¥è·³è¿‡ä¸¤æ¬¡è·³æ¿æœºè·³ä¸Šå»äº†
	* å¯¹äºä¸€äº›é¢å¤–çš„é…ç½®æ¯”å¦‚è¯´ç«¯å£æ˜ å°„ï¼Œå¯ä»¥ç›´æ¥åŠ è½½æœ€åçš„è¿™ä¸ªæŒ‡ä»¤ä¸­æ¯”å¦‚ ```ssh -L 10808:localhost:127.0.0.1 ztc.eva10``` 
* å…³äºä¸Šä¼ ç§é’¥ä»¥å…å¯†ç ç™»å½•
	* é¦–å…ˆå†æœ¬åœ°è¿›è¡Œssh-keygenï¼Œä¼šæœ‰ä¸€ä¸ªid_rsaï¼ˆç§é’¥ï¼‰ï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ªid_rsa.pubå…¬é’¥ï¼ˆè¿™ä¸ªæ¯”ç¬¬ä¸€ä¸ªçŸ­ä¸€äº›ï¼‰
	* å…¶å®åªæ˜¯éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå°†æœ¬åœ°çš„id_rsa.pubçš„å†…å®¹æ·»åŠ åˆ°./ssh/authorized_keyså½“ä¸­å³å¯ 
		* ç”¨```echo XXX >> authorized_keys``` è¿™ç§å½¢å¼

---

# Ray Setup
1. å®‰è£…ray
2. æŒ‰ç…§scripts/python rayå¤‡æ³¨ä¸­çš„æ ¼å¼è®¾ç½®ray(æ¯ä¸ªæœºå™¨æˆ–è€…conda envåªéœ€è¦è®¾ç½®ä¸€æ¬¡)
	* éœ€è¦è®°å½•ä¸‹ä¸€ä¸ªredis-dir
	* ![](https://github.com/A-suozhang/MyPicBed/raw/master/img/20200104165140.png)
3. æ–°å»ºä¸€ä¸ªexperimentæ–‡ä»¶å¤¹,å†…éƒ¨è¯´æ˜æ–¹æ³•çš„åå­—
4. å†™ä¸€ä¸ªè„šæœ¬ç”Ÿæˆæ–°çš„yamlæ–‡ä»¶,æ”¾ç½®åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹
5. è°ƒç”¨è„šæœ¬ python train_ray.py --redisdir=XXX $PATH_TO_YAML_DIR
	* åˆ™ä¼šè‡ªåŠ¨loadä¸‹dirç›®å½•ä¸‹çš„æ¯ä¸ªyamlæ–‡ä»¶
	* æ¯å½“ä¸€ä¸ªå®éªŒå®Œæˆä¹‹åä¼šè‡ªåŠ¨å»ºç«‹ä¸€ä¸ªè¿›ç¨‹å°†æ–°çš„å®éªŒæ·»åŠ è¿›å»
	* æœ‰ä¸¤ä¸ªå¿…é¡»çš„arg
		* redis-addr å¯åŠ¨rayæ—¶å€™ä¼šç»™çš„åœ°å€
		* result-base-dir å­˜æ”¾logçš„åœ°å€
			* ä¼šè‡ªåŠ¨appendä¸Šè¿™æ¬¡è°ƒæ•´çš„å‚æ•°çš„åå­—(ä¹Ÿå°±æ˜¯experimentçš„yaml settingæ‰€åœ¨çš„dirå‰é¢ä¸€å±‚)
		* å†åé¢å°±æ˜¯æ­£å¸¸mainå‡½æ•°çš„yamlæ‰€åœ¨çš„æ–‡ä»¶å¤¹,ä¼šè¯»å–è¯¥æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰yamlå¹¶ä¸”è·‘

* è®°ä¸ä½redis-addræ€ä¹ˆåŠ,å› ä¸ºæ¯ä¸€æ¬¡start rayçš„æ—¶å€™ä¼šéšæœºäº§ç”Ÿä¸€ä¸ª,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ª,åœ¨rayçš„å‘½ä»¤é‡Œ
	* ```alias ray-start="CUDA_VISIBLE_DEVICES=0,1,2,3 ray start --head --num-cpus 10 --num-gpus 4 --object-store-memory 10000000 --redis-port=12450```


## Trouble Shooting

* åœ¨å“ªä¸ªè·¯å¾„ä¸‹å¯åŠ¨rayæ˜¯å¦å…³é”®?
* æ˜¯å¦å¯ä»¥å–‚è¿›å»å¤šä¸ªyamlçš„dir
